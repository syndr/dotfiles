# Use a docker image for SSH (old network devices)
#
# Make sure that ~/.ssh/config.openssh7 exists and then
# source this file in your .bashrc or .zshrc
#

oldssh() {
  local has_user=0
  for arg in "$@"; do
    # Check for user@host pattern
    if [[ "$arg" =~ ^[^@]+@[^@]+$ ]]; then
      has_user=1
      break
    fi
    # Check for -l or -o User=
    if [[ "$arg" == "-l" ]] || [[ "$arg" == "-l"* ]] || [[ "$arg" == "-o" && "$arg" == *"User="* ]]; then
      has_user=1
      break
    fi
  done

  if [[ $has_user -eq 0 ]]; then
    docker run --rm -it \
      -v "$HOME/.ssh:/home/user/.ssh:ro" \
      -u "$(id -u):$(id -g)" \
      -w /home/user \
      openssh7-client:7.0 -F /home/user/.ssh/config.openssh7 \
      -o StrictHostKeyChecking=no \
      -o UserKnownHostsFile=/dev/null \
      -l "$USER" "$@"
  else
    docker run --rm -it \
      -v "$HOME/.ssh:/home/user/.ssh:ro" \
      -u "$(id -u):$(id -g)" \
      -w /home/user \
      openssh7-client:7.0 -F /home/user/.ssh/config.openssh7 \
      -o StrictHostKeyChecking=no \
      -o UserKnownHostsFile=/dev/null \
      "$@"
  fi
}

